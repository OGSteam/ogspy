name: OGSpy Release

on:
  push:
    branches: [ "develop" , "master"]
  pull_request:
    branches: [ "develop" ]

permissions:
  contents: write

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name : Checkout OGSPY
      uses: actions/checkout@v3
      
    - name: 'Get Previous tag'
      id: previoustag
      uses: "WyriHaximus/github-action-get-previous-tag@v1.3.0"
      with:
        fallback: 1.0.0 # Optional fallback tag to use when no tag can be found

    - name: 'Get next minor version'
      id: semvers
      uses: "WyriHaximus/github-action-next-semvers@v1"
      with:
         version: ${{ steps.previoustag.outputs.tag }}

    - name: Validate composer.json and composer.lock
      run: composer validate --strict

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress
      
    - name: Replace Value
      uses: jacobtomlinson/gha-find-replace@v3
      with:
          include : 'install/version.php'
          find : '0.0.0-dev'
          replace: ${{ steps.semvers.outputs.patch }}
          regex: false
    
    - name: Checkout Xtense
      uses: actions/checkout@v3
      with:
        repository: 'ogsteam/mod-xtense'
        ref: 'master'
        path: 'mod/xtense'
        
    - name: Checkout AutoUpdate
      uses: actions/checkout@v3
      with:
        repository: 'ogsteam/mod-autoupdate'
        ref: 'master'
        path: 'mod/autoupdate'
    
    - name: Zip Release
      # You may pin to the exact commit or the version.
      # uses: TheDoctor0/zip-release@a24011d8d445e4da5935a7e73c1f98e22a439464
      uses: TheDoctor0/zip-release@0.7.1
      with:
        # Filename for archive
        filename: ogspy-${{ steps.semvers.outputs.patch }}.zip
        # Base path for archive files
        #path: # optional, default is .
        # Working directory before zipping
        #directory: # optional, default is .
        # List of excluded files / directories
        exclusions: '*.git* *.vscode* *.docker* sonar-project.properties .editorconfig composer.*'
        # List of excluded files / directories with recursive wildcards (only applies on Windows with `zip` type)
        #recursive_exclusions: # optional, default is 
        # Provide any custom parameters to the command
        #custom: # optional, default is 
        # Tool to use for archiving
        #type: # optional, default is zip
        
    - uses: ncipollo/release-action@v1
      with:
        name : OGSpy ${{ steps.semvers.outputs.patch }}
        draft: true
        artifacts: "ogspy-${{ steps.semvers.outputs.patch }}.zip"
        artifactContentType: zip
        body : "To be Completed"
        tag : ${{ steps.semvers.outputs.patch }}
